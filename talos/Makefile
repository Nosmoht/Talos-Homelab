CLUSTER_NAME := homelab
ENDPOINT := https://192.168.2.60:6443
TALOS_VERSION := v1.12.4
KUBERNETES_VERSION := v1.35.0

-include .schematic-ids.mk

CP_NODES := node-01 node-02 node-03
WORKER_NODES := node-04 node-05 node-06
GPU_NODES := node-gpu-01
ALL_NODES := $(CP_NODES) $(WORKER_NODES) $(GPU_NODES)

# Node IPs (192.168.2.0/24 network)
IP_node-01 := 192.168.2.61
IP_node-02 := 192.168.2.62
IP_node-03 := 192.168.2.63
IP_node-04 := 192.168.2.64
IP_node-05 := 192.168.2.65
IP_node-06 := 192.168.2.66
IP_node-gpu-01 := 192.168.2.67

# SOPS-decrypted secrets (intermediate file)
SECRETS_DEC := .secrets.dec.yaml

# Track version variable changes — forces config regeneration when versions change
VERSION_VARS := $(TALOS_VERSION) $(KUBERNETES_VERSION)
VERSION_STAMP := .versions.stamp
$(shell echo '$(VERSION_VARS)' | cmp -s - $(VERSION_STAMP) || echo '$(VERSION_VARS)' > $(VERSION_STAMP))

# Install images (constructed from schematic IDs + version)
INSTALL_IMAGE := factory.talos.dev/metal-installer/$(SCHEMATIC_ID):$(TALOS_VERSION)
GPU_INSTALL_IMAGE := factory.talos.dev/metal-installer/$(GPU_SCHEMATIC_ID):$(TALOS_VERSION)

# Per-node image mapping
$(foreach node,$(CP_NODES) $(WORKER_NODES),$(eval IMAGE_$(node) = $$(INSTALL_IMAGE)))
$(foreach node,$(GPU_NODES),$(eval IMAGE_$(node) = $$(GPU_INSTALL_IMAGE)))

.PHONY: all gen-secrets gen-configs schematics talosconfig clean \
	$(addprefix install-,$(ALL_NODES)) bootstrap \
	$(addprefix apply-,$(ALL_NODES)) apply-all \
	$(addprefix dry-run-,$(ALL_NODES)) dry-run-all \
	$(addprefix upgrade-,$(ALL_NODES))

all: gen-configs

gen-secrets:
	talosctl gen secrets -o secrets.yaml

# SOPS decryption target
$(SECRETS_DEC): secrets.yaml
	sops -d $< > $@

gen-configs: $(addprefix generated/controlplane/,$(addsuffix .yaml,$(CP_NODES))) \
	$(addprefix generated/worker/,$(addsuffix .yaml,$(WORKER_NODES))) \
	$(addprefix generated/worker/,$(addsuffix .yaml,$(GPU_NODES)))

generated/controlplane/%.yaml: patches/common.yaml patches/controlplane.yaml nodes/%.yaml $(SECRETS_DEC) .schematic-ids.mk $(VERSION_STAMP)
	talosctl gen config $(CLUSTER_NAME) $(ENDPOINT) \
		--with-secrets $(SECRETS_DEC) \
		--config-patch @patches/common.yaml \
		--config-patch @patches/controlplane.yaml \
		--config-patch @nodes/$*.yaml \
		--config-patch '{"machine":{"install":{"image":"$(INSTALL_IMAGE)"}}}' \
		--output $@ \
		--output-types controlplane \
		--talos-version $(TALOS_VERSION) \
		--kubernetes-version $(KUBERNETES_VERSION) \
		--force
	yq eval-all 'del(select(.kind == "HostnameConfig").auto)' -i $@

generated/worker/node-gpu-%.yaml: patches/common.yaml patches/worker-gpu.yaml nodes/node-gpu-%.yaml $(SECRETS_DEC) .schematic-ids.mk $(VERSION_STAMP)
	talosctl gen config $(CLUSTER_NAME) $(ENDPOINT) \
		--with-secrets $(SECRETS_DEC) \
		--config-patch @patches/common.yaml \
		--config-patch @patches/worker-gpu.yaml \
		--config-patch @nodes/node-gpu-$*.yaml \
		--config-patch '{"machine":{"install":{"image":"$(GPU_INSTALL_IMAGE)"}}}' \
		--output $@ \
		--output-types worker \
		--talos-version $(TALOS_VERSION) \
		--kubernetes-version $(KUBERNETES_VERSION) \
		--force
	yq eval-all 'del(select(.kind == "HostnameConfig").auto)' -i $@

generated/worker/%.yaml: patches/common.yaml nodes/%.yaml $(SECRETS_DEC) .schematic-ids.mk $(VERSION_STAMP)
	talosctl gen config $(CLUSTER_NAME) $(ENDPOINT) \
		--with-secrets $(SECRETS_DEC) \
		--config-patch @patches/common.yaml \
		--config-patch @nodes/$*.yaml \
		--config-patch '{"machine":{"install":{"image":"$(INSTALL_IMAGE)"}}}' \
		--output $@ \
		--output-types worker \
		--talos-version $(TALOS_VERSION) \
		--kubernetes-version $(KUBERNETES_VERSION) \
		--force
	yq eval-all 'del(select(.kind == "HostnameConfig").auto)' -i $@

talosconfig: secrets.yaml
	talosctl gen config $(CLUSTER_NAME) $(ENDPOINT) \
		--with-secrets secrets.yaml \
		--output talosconfig \
		--output-types talosconfig \
		--talos-version $(TALOS_VERSION)

# Create schematics via Image Factory API and write IDs to .schematic-ids.mk
.schematic-ids.mk: talos-factory-schematic.yaml talos-factory-schematic-gpu.yaml
	@echo "Creating standard schematic..."
	@STD_ID=$$(curl -sS -X POST -H 'Content-Type: application/yaml' \
		--data-binary @talos-factory-schematic.yaml \
		https://factory.talos.dev/schematics | jq -r '.id') && \
	echo "Standard schematic ID: $$STD_ID" && \
	echo "Creating GPU schematic..." && \
	GPU_ID=$$(curl -sS -X POST -H 'Content-Type: application/yaml' \
		--data-binary @talos-factory-schematic-gpu.yaml \
		https://factory.talos.dev/schematics | jq -r '.id') && \
	echo "GPU schematic ID: $$GPU_ID" && \
	printf '# Auto-generated by: make schematics\nSCHEMATIC_ID := %s\nGPU_SCHEMATIC_ID := %s\n' \
		"$$STD_ID" "$$GPU_ID" > $@ && \
	echo "Done. Written IDs to $@"

schematics: .schematic-ids.mk

# Helper to resolve config path for a node
config-path = generated/$(if $(filter $(1),$(CP_NODES)),controlplane,worker)/$(1).yaml

# Install targets — initial config apply to fresh nodes (--insecure, no TLS yet)
define INSTALL_TEMPLATE
install-$(1): $$(call config-path,$(1))
	talosctl apply-config --insecure --nodes $$(IP_$(1)) --file $$(call config-path,$(1))
endef

$(foreach node,$(ALL_NODES),$(eval $(call INSTALL_TEMPLATE,$(node))))

# Bootstrap etcd on first control plane node
bootstrap:
	talosctl bootstrap --nodes $(IP_node-01) --endpoints $(IP_node-01)

# Apply targets
define APPLY_TEMPLATE
apply-$(1): $$(call config-path,$(1))
	talosctl apply-config --nodes $$(IP_$(1)) --file $$(call config-path,$(1))
endef

$(foreach node,$(ALL_NODES),$(eval $(call APPLY_TEMPLATE,$(node))))

apply-all: $(addprefix apply-,$(ALL_NODES))

# Dry-run targets
define DRY_RUN_TEMPLATE
dry-run-$(1): $$(call config-path,$(1))
	talosctl apply-config --nodes $$(IP_$(1)) --file $$(call config-path,$(1)) --dry-run
endef

$(foreach node,$(ALL_NODES),$(eval $(call DRY_RUN_TEMPLATE,$(node))))

dry-run-all: $(addprefix dry-run-,$(ALL_NODES))

# Upgrade targets — apply config then upgrade to new install image
define UPGRADE_TEMPLATE
upgrade-$(1): $$(call config-path,$(1))
	talosctl apply-config --nodes $$(IP_$(1)) --file $$(call config-path,$(1))
	talosctl upgrade --nodes $$(IP_$(1)) \
		--image $$(IMAGE_$(1)) \
		--wait --timeout 10m
endef

$(foreach node,$(ALL_NODES),$(eval $(call UPGRADE_TEMPLATE,$(node))))

clean:
	rm -rf generated/controlplane/*.yaml generated/worker/*.yaml
	rm -f $(SECRETS_DEC) $(VERSION_STAMP)
